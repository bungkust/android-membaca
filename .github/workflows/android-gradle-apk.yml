name: Android APK Build (Gradle)

on:
  workflow_dispatch:
    inputs:
      buildType:
        description: 'Build type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release

jobs:
  build-android:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: Setup Java
        id: setup-java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Verify Android SDK environment
        run: |
          echo "ANDROID_HOME: ${ANDROID_HOME:-NOT SET}"
          echo "ANDROID_SDK_ROOT: ${ANDROID_SDK_ROOT:-NOT SET}"
          if [ -z "$ANDROID_HOME" ] && [ -z "$ANDROID_SDK_ROOT" ]; then
            echo "ERROR: Android SDK not configured"
            exit 1
          fi

      - name: Complete cleanup
        run: |
          rm -rf node_modules packages/*/node_modules packages/*/.expo
          # Keep pnpm-lock.yaml if it exists for deterministic installs
          # Only remove other lockfiles
          rm -f yarn.lock package-lock.json
          pnpm store prune || true
          # Verify if lockfile exists
          if [ -f "pnpm-lock.yaml" ]; then
            echo "pnpm-lock.yaml found - will use --frozen-lockfile for deterministic installs"
          else
            echo "pnpm-lock.yaml not found - will use --shamefully-hoist without lockfile"
          fi

      - name: Re-install dependencies with hoisting (CI-safe)
        run: |
          # Install workspace at repo root so pnpm can hoist native deps correctly
          pnpm -v
          # Use frozen-lockfile if lockfile exists, otherwise use shamefully-hoist for deterministic installs
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --shamefully-hoist
          else
            pnpm install --shamefully-hoist
          fi

      - name: Install workspace packages
        run: |
          # Install all workspace packages explicitly
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --shamefully-hoist --filter "./packages/core" --filter "./packages/storage" --filter "./packages/tts"
          else
            pnpm install --shamefully-hoist --filter "./packages/core" --filter "./packages/storage" --filter "./packages/tts"
          fi
          # Verify workspace packages exist (check both hoisted and local locations)
          if [ ! -d "node_modules/@repo/core" ] && [ ! -d "packages/core/node_modules" ]; then
            echo "ERROR: @repo/core not found after install"
            exit 1
          fi
          if [ ! -d "node_modules/@repo/storage" ] && [ ! -d "packages/storage/node_modules" ]; then
            echo "ERROR: @repo/storage not found after install"
            exit 1
          fi
          if [ ! -d "node_modules/@repo/tts" ] && [ ! -d "packages/tts/node_modules" ]; then
            echo "ERROR: @repo/tts not found after install"
            exit 1
          fi
          echo "All workspace packages verified"

      - name: "Debug: verify installs and expo-modules-core"
        run: |
          node -v; pnpm -v; java -version
          echo "ROOT node_modules/.pnpm listing:"
          ls -la node_modules/.pnpm | sed -n '1,200p' || true
          echo "packages/mobile node_modules listing:"
          ls -la packages/mobile/node_modules | sed -n '1,200p' || true
          test -d packages/mobile/node_modules/expo-modules-core/android/src/main/kotlin && echo "expo-modules-core kotlin present in packages/mobile" || echo "expo-modules-core kotlin MISSING in packages/mobile"

      - name: Verify expo CLI
        run: |
          # Verify expo CLI is accessible and works
          pnpm dlx expo --version || {
            echo "ERROR: expo CLI not accessible"
            exit 1
          }
          echo "expo CLI verified"

      - name: Get version info
        id: version
        working-directory: packages/mobile
        run: |
          # Add error handling for app.json parsing
          VERSION=$(node -p "require('./app.json').expo.version" 2>&1) || {
            echo "ERROR: Failed to parse app.json"
            cat app.json || true
            exit 1
          }
          BUILD_DATE=$(date +'%Y%m%d')
          BUILD_TIME=$(date +'%H%M%S')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "build_time=$BUILD_TIME" >> $GITHUB_OUTPUT
          echo "APK_NAME=belajar-membaca-v${VERSION}-${{ inputs.buildType }}-${BUILD_DATE}-${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "APK Name: belajar-membaca-v${VERSION}-${{ inputs.buildType }}-${BUILD_DATE}-${BUILD_TIME}"

      - name: Install mobile package deps (CI-safe)
        run: |
          # Install only mobile package dependencies in workspace root so pnpm filter works correctly
          if [ -f "pnpm-lock.yaml" ]; then
            pnpm install --frozen-lockfile --shamefully-hoist --filter ./packages/mobile...
          else
            pnpm install --shamefully-hoist --filter ./packages/mobile...
          fi

      - name: Verify dependency versions
        run: |
          echo "Verifying installed dependency versions match package.json..."
          cd packages/mobile
          # Check critical dependencies
          echo "Checking expo version..."
          EXPO_INSTALLED=$(pnpm list expo --depth=0 2>/dev/null | grep "expo@" | head -1 | awk '{print $2}' | sed 's/@//' || echo "NOT_FOUND")
          EXPO_EXPECTED=$(node -p "require('./package.json').dependencies.expo" 2>/dev/null || echo "NOT_FOUND")
          echo "Expo: expected $EXPO_EXPECTED, installed $EXPO_INSTALLED"
          
          echo "Checking expo-modules-core version..."
          EXPO_CORE_INSTALLED=$(pnpm list expo-modules-core --depth=0 2>/dev/null | grep "expo-modules-core@" | head -1 | awk '{print $2}' | sed 's/@//' || echo "NOT_FOUND")
          EXPO_CORE_EXPECTED=$(node -p "require('./package.json').dependencies['expo-modules-core']" 2>/dev/null || echo "NOT_FOUND")
          echo "expo-modules-core: expected $EXPO_CORE_EXPECTED, installed $EXPO_CORE_INSTALLED"
          
          echo "Checking react-native version..."
          RN_INSTALLED=$(pnpm list react-native --depth=0 2>/dev/null | grep "react-native@" | head -1 | awk '{print $2}' | sed 's/@//' || echo "NOT_FOUND")
          RN_EXPECTED=$(node -p "require('./package.json').dependencies['react-native']" 2>/dev/null || echo "NOT_FOUND")
          echo "react-native: expected $RN_EXPECTED, installed $RN_INSTALLED"
          
          echo "Checking react-native-safe-area-context version..."
          SAFE_AREA_INSTALLED=$(pnpm list react-native-safe-area-context --depth=0 2>/dev/null | grep "react-native-safe-area-context@" | head -1 | awk '{print $2}' | sed 's/@//' || echo "NOT_FOUND")
          SAFE_AREA_EXPECTED=$(node -p "require('./package.json').dependencies['react-native-safe-area-context']" 2>/dev/null || echo "NOT_FOUND")
          echo "react-native-safe-area-context: expected $SAFE_AREA_EXPECTED, installed $SAFE_AREA_INSTALLED"
          
          # Check for major version mismatches (warn but don't fail)
          if [ "$EXPO_INSTALLED" != "NOT_FOUND" ] && [ "$EXPO_EXPECTED" != "NOT_FOUND" ]; then
            EXPO_MAJOR_INSTALLED=$(echo "$EXPO_INSTALLED" | cut -d. -f1)
            EXPO_MAJOR_EXPECTED=$(echo "$EXPO_EXPECTED" | cut -d. -f1 | sed 's/~//')
            if [ "$EXPO_MAJOR_INSTALLED" != "$EXPO_MAJOR_EXPECTED" ]; then
              echo "WARNING: Major version mismatch for expo: expected $EXPO_MAJOR_EXPECTED.x, got $EXPO_MAJOR_INSTALLED.x"
            fi
          fi
          
          echo "Dependency version check completed"

      - name: Ensure expo-modules-core present in mobile package (defensive)
        run: |
          # Ensure expo-modules-core is installed in the mobile workspace and contains Kotlin files
          EXPO_MOD_PATH="packages/mobile/node_modules/expo-modules-core"
          
          # Check if Kotlin files exist
          if [ ! -d "$EXPO_MOD_PATH" ] || ! find "$EXPO_MOD_PATH/android" -name "*.kt" -print -quit >/dev/null 2>&1; then
            echo "expo-modules-core kotlin sources missing or package missing; reinstalling expo-modules-core@3.0.25..."
            if [ -f "pnpm-lock.yaml" ]; then
              pnpm --filter ./packages/mobile... add expo-modules-core@3.0.25 --frozen-lockfile --shamefully-hoist
            else
              pnpm --filter ./packages/mobile... add expo-modules-core@3.0.25 --shamefully-hoist
            fi
          fi
          
          # Verify again - must find actual Kotlin files
          if ! find "$EXPO_MOD_PATH/android" -name "*.kt" -print -quit >/dev/null 2>&1; then
            echo "ERROR: expo-modules-core Kotlin sources still missing. Listing package tree for debugging:"
            ls -la "$EXPO_MOD_PATH" || true
            find "$EXPO_MOD_PATH" -maxdepth 4 -type f | head -200 || true
            echo "Checking android directory structure:"
            ls -la "$EXPO_MOD_PATH/android" 2>/dev/null || echo "android directory missing"
            find "$EXPO_MOD_PATH/android" -type d 2>/dev/null | head -20 || true
            exit 1
          fi
          
          echo "expo-modules-core kotlin sources present"
          # Show where Kotlin files are located
          echo "Kotlin files found at:"
          find "$EXPO_MOD_PATH/android" -name "*.kt" -type f 2>/dev/null | head -10 || true

      - name: "Debug: verify expo-modules-core layout"
        run: |
          echo "Root pnpm listing (trimmed):"
          ls -la node_modules/.pnpm | sed -n '1,200p' || true
          echo "Check expo-modules-core locations:"
          find node_modules -path "*/expo-modules-core" -maxdepth 4 -type d -print || true
          echo "packages/mobile/node_modules listing:"
          ls -la packages/mobile/node_modules | sed -n '1,200p' || true
          echo "Look for expo-modules-core paths:"
          ls -la packages/mobile/node_modules/expo-modules-core || true
          ls -la node_modules/.pnpm | grep expo-modules-core || true
          # Check for expo-modules-core in multiple ways
          if [ -d "packages/mobile/node_modules/expo-modules-core/android/src/main/kotlin" ]; then
            echo "expo-modules-core kotlin present (standard location)"
          elif find packages/mobile/node_modules/expo-modules-core/android -name "*.kt" -type f 2>/dev/null | grep -q .; then
            echo "expo-modules-core kotlin files found (non-standard location)"
          elif [ -d "packages/mobile/node_modules/expo-modules-core/android" ] && [ -f "packages/mobile/node_modules/expo-modules-core/android/build.gradle" ]; then
            echo "expo-modules-core android folder exists with build.gradle"
          else
            echo "expo-modules-core kotlin MISSING"
          fi

      - name: Pre-prebuild verification
        run: |
          echo "Verifying all critical dependencies before prebuild..."
          # Verify expo-modules-core - must have actual Kotlin files
          EXPO_MODULES_PATH="packages/mobile/node_modules/expo-modules-core"
          if [ ! -d "$EXPO_MODULES_PATH" ]; then
            echo "ERROR: expo-modules-core package not found"
            exit 1
          fi
          if ! find "$EXPO_MODULES_PATH/android" -name "*.kt" -type f 2>/dev/null | grep -q .; then
            echo "ERROR: expo-modules-core Kotlin sources not found"
            echo "Package structure:"
            ls -la "$EXPO_MODULES_PATH" || true
            find "$EXPO_MODULES_PATH/android" -type d 2>/dev/null | head -20 || true
            exit 1
          fi
          echo "✅ expo-modules-core Kotlin sources verified"
          # Verify react-native-safe-area-context has sources
          if [ ! -d "packages/mobile/node_modules/react-native-safe-area-context/android/src/main/java" ] && [ ! -d "packages/mobile/node_modules/react-native-safe-area-context/android/src/main/kotlin" ]; then
            echo "WARNING: react-native-safe-area-context sources not found, but continuing..."
          fi
          # Verify react-native-screens has sources
          if [ ! -d "packages/mobile/node_modules/react-native-screens/android/src/main/java" ] && [ ! -d "packages/mobile/node_modules/react-native-screens/android/src/main/kotlin" ]; then
            echo "WARNING: react-native-screens sources not found, but continuing..."
          fi
          # Verify workspace packages are accessible
          if [ ! -d "node_modules/@repo/core" ] && [ ! -d "packages/core/node_modules" ]; then
            echo "ERROR: @repo/core not accessible"
            exit 1
          fi
          # Verify app.json is valid JSON
          node -e "require('./packages/mobile/app.json')" || {
            echo "ERROR: app.json is invalid JSON"
            exit 1
          }
          # Test expo CLI
          pnpm dlx expo --version > /dev/null || {
            echo "ERROR: expo CLI not functional"
            exit 1
          }
          echo "All pre-prebuild verifications passed"

      - name: Prebuild Android (fixed)
        working-directory: packages/mobile
        env:
          EXPO_NO_NEW_ARCH: 1
          EXPO_USE_NEW_ARCH: 0
          RCT_NEW_ARCH_ENABLED: 0
          NODE_ENV: production
        run: |
          # Debug: show expo CLI version
          pnpm dlx expo --version || true
          # Prebuild with error capture on each attempt
          PREBUILD_SUCCESS=false
          for i in 1 2 3; do
            echo "Prebuild attempt $i/3"
            pnpm dlx expo prebuild --platform android --clean 2>&1 | tee "prebuild-attempt-$i.log"
            EXIT_CODE=${PIPESTATUS[0]}
            if [ $EXIT_CODE -eq 0 ] && [ -d android ]; then
              PREBUILD_SUCCESS=true
              echo "Prebuild succeeded on attempt $i"
              break
            else
              echo "Attempt $i failed with exit code $EXIT_CODE. Last 30 lines:"
              tail -30 "prebuild-attempt-$i.log"
              if [ $i -lt 3 ]; then
                echo "Retrying in 5s..."
            sleep 5
              fi
            fi
          done
          if [ "$PREBUILD_SUCCESS" != "true" ]; then
            echo "Prebuild failed after 3 attempts. Showing all logs:"
            for log in prebuild-attempt-*.log; do
              echo "=== $log ==="
              cat "$log" || true
            done
            echo "Current directory contents:"
            ls -la || true
            exit 1
          fi
          # Verify android folder structure
          if [ ! -d android/app ] || [ ! -f android/build.gradle ] || [ ! -d android/gradle ]; then
            echo "ERROR: android/ folder structure incomplete"
            ls -la android/ || true
            exit 1
          fi
          echo "Android project structure verified"

      - name: Show expo config (debug)
        working-directory: packages/mobile
        run: |
          node -e "console.log(require('./app.json'))"
          pnpm dlx expo config --json || true

      - name: Inspect node_modules layout (debug)
        run: |
          ls -la node_modules | sed -n '1,200p' || true
          ls -la node_modules/.pnpm | sed -n '1,200p' || true
          ls -la packages/mobile/node_modules | sed -n '1,200p' || true
          ls -la packages/mobile/node_modules/.pnpm | sed -n '1,200p' || true
          # Check for expo-modules-core in multiple ways
          if [ -d "packages/mobile/node_modules/expo-modules-core/android/src/main/kotlin" ]; then
            echo "expo-modules-core kotlin sources present (standard location)"
          elif find packages/mobile/node_modules/expo-modules-core/android -name "*.kt" -type f 2>/dev/null | grep -q .; then
            echo "expo-modules-core kotlin sources present (non-standard location)"
          elif [ -d "packages/mobile/node_modules/expo-modules-core/android" ] && [ -f "packages/mobile/node_modules/expo-modules-core/android/build.gradle" ]; then
            echo "expo-modules-core android folder exists with build.gradle"
          else
            echo "expo-modules-core kotlin sources MISSING"
          fi
          test -d packages/mobile/node_modules/react-native-safe-area-context/android/src/main/java && echo "safe-area-context java sources present" || echo "safe-area-context java sources MISSING"

      - name: Ensure android project exists
        run: |
          if [ ! -d "packages/mobile/android" ]; then
            echo "ERROR: expected packages/mobile/android to exist after expo prebuild"
            ls -la packages/mobile
            exit 1
          fi

      - name: Ensure Kotlin version compatibility
        working-directory: packages/mobile/android
        run: |
          GRADLE_FILE="build.gradle"
          if [ ! -f "$GRADLE_FILE" ]; then
            echo "ERROR: build.gradle not found"
            exit 1
          fi
          if ! grep -q "ext.kotlinVersion" "$GRADLE_FILE"; then
            echo "Kotlin version not set, setting to 2.0.20 (required by Expo SDK 54, matches app.json)"
            # Check if buildscript block exists
            if grep -q "buildscript" "$GRADLE_FILE"; then
              # Try to find dependencies block in buildscript and add ext before it
              if grep -q "dependencies" "$GRADLE_FILE"; then
                # Use awk to insert ext.kotlinVersion before dependencies in buildscript
                awk '
                  /buildscript \{/ { in_buildscript=1; print; next }
                  in_buildscript && /dependencies \{/ { 
                    print "    ext.kotlinVersion = \"2.0.20\""
                    print
                    next
                  }
                  { print }
                ' "$GRADLE_FILE" > "$GRADLE_FILE.tmp" && mv "$GRADLE_FILE.tmp" "$GRADLE_FILE"
              else
                # No dependencies block, add ext after buildscript {
                sed -i '/buildscript {/a\    ext.kotlinVersion = "2.0.20"' "$GRADLE_FILE"
              fi
            else
              # No buildscript, add at top level
              echo "ext { kotlinVersion = \"2.0.20\" }" | cat - "$GRADLE_FILE" > "$GRADLE_FILE.tmp" && mv "$GRADLE_FILE.tmp" "$GRADLE_FILE"
            fi
            # Verify it was added
            if ! grep -q "ext.kotlinVersion" "$GRADLE_FILE"; then
              echo "ERROR: Failed to set Kotlin version"
              exit 1
            fi
            echo "Kotlin version 2.0.20 set successfully"
          else
            echo "ext.kotlinVersion already set in build.gradle"
            grep "kotlinVersion" "$GRADLE_FILE" || true
          fi
          
          # Verify Kotlin version matches app.json
          echo "Verifying Kotlin version matches app.json..."
          APP_JSON_KOTLIN=$(node -p "require('../../app.json').expo.plugins.find(p => Array.isArray(p) && p[0] === 'expo-build-properties')?.[1]?.android?.kotlinVersion || 'NOT_FOUND'" 2>/dev/null || echo "NOT_FOUND")
          GRADLE_KOTLIN=$(grep "ext.kotlinVersion" "$GRADLE_FILE" | head -1 | sed 's/.*kotlinVersion.*"\([^"]*\)".*/\1/' || echo "NOT_FOUND")
          
          echo "app.json kotlinVersion: $APP_JSON_KOTLIN"
          echo "build.gradle kotlinVersion: $GRADLE_KOTLIN"
          
          if [ "$APP_JSON_KOTLIN" != "NOT_FOUND" ] && [ "$GRADLE_KOTLIN" != "NOT_FOUND" ]; then
            if [ "$APP_JSON_KOTLIN" != "$GRADLE_KOTLIN" ]; then
              echo "WARNING: Kotlin version mismatch between app.json ($APP_JSON_KOTLIN) and build.gradle ($GRADLE_KOTLIN)"
              echo "Updating build.gradle to match app.json..."
              # Update the version in build.gradle to match app.json
              sed -i "s/ext.kotlinVersion = \".*\"/ext.kotlinVersion = \"$APP_JSON_KOTLIN\"/g" "$GRADLE_FILE"
              sed -i "s/kotlinVersion = \".*\"/kotlinVersion = \"$APP_JSON_KOTLIN\"/g" "$GRADLE_FILE"
              echo "Updated build.gradle to use Kotlin $APP_JSON_KOTLIN"
            else
              echo "✅ Kotlin version sync verified: $GRADLE_KOTLIN"
            fi
          else
            echo "Could not verify Kotlin version sync (app.json: $APP_JSON_KOTLIN, build.gradle: $GRADLE_KOTLIN)"
          fi

      - name: Verify Gradle dependencies and versions
        working-directory: packages/mobile/android
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
        run: |
          echo "Checking Gradle configuration and dependencies..."
          chmod +x gradlew
          # Check Kotlin version in build.gradle
          if grep -q "ext.kotlinVersion" build.gradle; then
            KOTLIN_VER=$(grep "ext.kotlinVersion" build.gradle | head -1 | sed 's/.*kotlinVersion.*"\([^"]*\)".*/\1/')
            echo "Kotlin version in build.gradle: $KOTLIN_VER"
          fi
          # Run gradle dependencies to see resolved versions (limited output)
          echo "Checking resolved dependency versions..."
          ./gradlew dependencies --configuration debugRuntimeClasspath 2>&1 | grep -E "(expo-modules-core|react-native-safe-area-context|kotlin)" | head -20 || true
          echo "Gradle dependency check completed"

      - name: Gradle clean
        working-directory: packages/mobile/android
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
        run: |
          # Verify android directory and gradlew exist before cleaning
          if [ ! -d "." ] || [ ! -f "gradlew" ]; then
            echo "ERROR: android directory or gradlew not found"
            exit 1
          fi
          echo "Using JAVA_HOME: $JAVA_HOME"
          java -version
          chmod +x gradlew
          ./gradlew clean || {
            echo "WARNING: gradlew clean failed, but continuing..."
          }

      - name: Ensure assets directory exists
        working-directory: packages/mobile
        run: |
          mkdir -p android/app/src/main/assets
          echo "Assets directory ready for bundle"

      - name: Prepare keystore (release only)
        if: ${{ inputs.buildType == 'release' }}
        working-directory: packages/mobile/android
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "Preparing Release Keystore"
          echo "$ANDROID_KEYSTORE_BASE64" | base64 -d > app/release.keystore
          if [ -f "app/release.keystore" ]; then
            ls -lh app/release.keystore
          else
            echo "Keystore creation failed!"
            exit 1
          fi

      - name: Debug Kotlin compile for react-native-safe-area-context
        working-directory: packages/mobile/android
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
        run: |
          echo "Running focused Kotlin compilation check for react-native-safe-area-context..."
          chmod +x gradlew
          ./gradlew :react-native-safe-area-context:compileDebugKotlin --info --stacktrace --warning-mode all 2>&1 | tee debug-kotlin.log
          EXIT_CODE=${PIPESTATUS[0]}
          echo "---- last 200 lines of debug-kotlin.log ----"
          tail -200 debug-kotlin.log || true
          
          # If it failed, copy artifact for inspection
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Kotlin compilation failed with exit code $EXIT_CODE"
            cp debug-kotlin.log ../../debug-kotlin-react-native-safe-area-context.log || true
            echo "Kotlin-specific errors:"
            grep -i "kotlin\|ksp\|compilation\|error" debug-kotlin.log | tail -50 || true
            echo "WARNING: Kotlin compilation failed, but continuing to full build for complete error output"
          else
            echo "✅ Kotlin compilation succeeded"
          fi

      - name: Build APK with Gradle
        working-directory: packages/mobile/android
        id: build
        env:
          JAVA_HOME: ${{ steps.setup-java.outputs.java-home }}
          EXPO_NO_NEW_ARCH: 1
          EXPO_USE_NEW_ARCH: 0
          RCT_NEW_ARCH_ENABLED: 0
          NODE_ENV: production
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_ALIAS_PASSWORD: ${{ secrets.ANDROID_KEY_ALIAS_PASSWORD }}
        run: |
          echo "Using JAVA_HOME: $JAVA_HOME"
          java -version
          chmod +x gradlew
          BUILD_TYPE="${{ inputs.buildType }}"
          LOG_FILE="gradle-build-${BUILD_TYPE}.log"
          if [ "$BUILD_TYPE" = "release" ]; then
            KEYSTORE_PATH="$(pwd)/app/release.keystore"
            if [ ! -f "$KEYSTORE_PATH" ]; then
              echo "ERROR: Keystore not found at $KEYSTORE_PATH"
              exit 1
            fi
            ./gradlew assembleRelease \
              -Pandroid.injected.signing.store.file="$KEYSTORE_PATH" \
              -Pandroid.injected.signing.store.password="$ANDROID_KEYSTORE_PASSWORD" \
              -Pandroid.injected.signing.key.alias="$ANDROID_KEY_ALIAS" \
              -Pandroid.injected.signing.key.password="$ANDROID_KEY_ALIAS_PASSWORD" \
              --info --stacktrace 2>&1 | tee "$LOG_FILE"
            EXIT_CODE=${PIPESTATUS[0]}
          else
            ./gradlew assembleDebug --info --stacktrace --warning-mode all 2>&1 | tee "$LOG_FILE"
            EXIT_CODE=${PIPESTATUS[0]}
          fi
          if [ $EXIT_CODE -ne 0 ]; then
            echo "Gradle build failed with exit code $EXIT_CODE"
            echo "Error summary:"
            grep -i "FAILED\|ERROR" "$LOG_FILE" | tail -30 || true
            echo "Last 100 lines of build log:"
            tail -100 "$LOG_FILE"
            # Show Kotlin-specific errors if any
            echo "Kotlin compilation errors (if any):"
            grep -i "kotlin\|ksp" "$LOG_FILE" | tail -20 || true
            # If Kotlin compilation failed, run focused debug
            if grep -qi "compile.*kotlin.*failed\|kotlin.*compilation.*error" "$LOG_FILE"; then
              echo "Running focused Kotlin compilation debug..."
              ./gradlew :react-native-safe-area-context:compileDebugKotlin --info --stacktrace 2>&1 | tee debug-kotlin.log || true
              echo "Focused Kotlin debug output:"
              tail -50 debug-kotlin.log || true
            fi
            exit 1
          fi
          echo "Gradle build succeeded. Checking for APK..."

      - name: Verify build output exists
        working-directory: packages/mobile/android
        run: |
          # Only run if previous build step succeeded (check exit code from build step)
          echo "Checking build output directories..."
          echo "Current directory: $(pwd)"
          echo "App directory exists: $([ -d app ] && echo 'YES' || echo 'NO')"
          if [ -d app ]; then
            echo "App build directory exists: $([ -d app/build ] && echo 'YES' || echo 'NO')"
            if [ -d app/build ]; then
              echo "App build outputs exists: $([ -d app/build/outputs ] && echo 'YES' || echo 'NO')"
              if [ -d app/build/outputs ]; then
                echo "Listing app/build/outputs:"
                ls -la app/build/outputs/ || true
              else
                echo "WARNING: app/build/outputs does not exist - build may have failed"
              fi
            else
              echo "WARNING: app/build does not exist - build may have failed"
            fi
          else
            echo "ERROR: app directory does not exist"
            exit 1
          fi
          echo "Searching for any APK files in app directory:"
          find app -name "*.apk" -type f 2>/dev/null | head -10 || echo "No APK files found in app directory"

      - name: Find and rename APK with timestamp
        working-directory: packages/mobile/android
        run: |
          echo "Searching for APK files..."
          APK_SOURCE=""
          
          # Try standard locations first
          if [ "${{ inputs.buildType }}" = "release" ]; then
            if [ -d "app/build/outputs/apk/release" ]; then
              APK_SOURCE=$(find app/build/outputs/apk/release -name "*.apk" -type f 2>/dev/null | head -1)
            fi
            if [ -z "$APK_SOURCE" ] && [ -d "app/build/outputs" ]; then
              APK_SOURCE=$(find app/build/outputs -name "*release*.apk" -type f 2>/dev/null | head -1)
            fi
          else
            if [ -d "app/build/outputs/apk/debug" ]; then
              APK_SOURCE=$(find app/build/outputs/apk/debug -name "*.apk" -type f 2>/dev/null | head -1)
            fi
            if [ -z "$APK_SOURCE" ] && [ -d "app/build/outputs" ]; then
              APK_SOURCE=$(find app/build/outputs -name "*debug*.apk" -type f 2>/dev/null | head -1)
            fi
          fi
          
          # If still not found, search more broadly
          if [ -z "$APK_SOURCE" ]; then
            echo "APK not found in standard locations, searching more broadly..."
            APK_SOURCE=$(find app -name "*.apk" -type f 2>/dev/null | head -1)
          fi
          
          # Last resort: search entire android directory
          if [ -z "$APK_SOURCE" ]; then
            echo "APK not found in app directory, searching entire android directory..."
            APK_SOURCE=$(find . -name "*.apk" -type f 2>/dev/null | head -1)
          fi
          
          if [ -z "$APK_SOURCE" ]; then
            echo "ERROR: APK file not found in any location!"
            echo "Build directory structure:"
            ls -la app/build/ 2>/dev/null || echo "app/build/ does not exist"
            ls -la app/build/outputs/ 2>/dev/null || echo "app/build/outputs/ does not exist"
            echo "All APK files in project:"
            find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found anywhere"
            exit 1
          fi
          
          echo "Found APK at: $APK_SOURCE"
          mkdir -p ../../../output
          cp "$APK_SOURCE" "../../../output/${{ steps.version.outputs.APK_NAME }}.apk"
          ls -lh ../../../output/

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: belajar-membaca-v${{ steps.version.outputs.version }}-${{ inputs.buildType }}
          path: output/${{ steps.version.outputs.APK_NAME }}.apk
          retention-days: 30


